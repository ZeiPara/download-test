<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCAddonファイル生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>MCAddonファイル生成</h1>

    <form id="data-form">
        <label for="name">名前:</label>
        <input type="text" id="name" required><br><br>

        <label for="english-name">英語のパックの名前:</label>
        <input type="text" id="english-name" required><br><br>

        <label for="description">説明:</label>
        <input type="text" id="description" required><br><br>

        <label for="item-name">アイテムの名前:</label>
        <input type="text" id="item-name" required><br><br>

        <label for="item-english-name">英語のアイテムの名前:</label>
        <input type="text" id="item-english-name" required><br><br>

        <label for="item-image">アイテムの画像(サイズは16の倍数の正方形):</label>
        <input type="file" id="item-image" required><br><br>

        <button type="button" id="create-mcaddon">MCAddon作成</button>
    </form>

    <a id="download-link" href="#" style="display:none;">ここをクリックしてダウンロード</a>

    <script>
        // UUID生成関数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.getElementById('create-mcaddon').addEventListener('click', async function () {
            // 入力データを取得
            const name = document.getElementById('name').value;
            const englishName = document.getElementById('english-name').value;
            const description = document.getElementById('description').value;
            const itemName = document.getElementById('item-name').value;
            const itemEnglishName = document.getElementById('item-english-name').value;
            const itemImageFile = document.getElementById('item-image').files[0];

            // UUIDを生成
            const UUIDA = generateUUID();
            const UUIDB = generateUUID();
            const UUIDC = generateUUID();
            const UUIDD = generateUUID();

            // RP ZIPファイルの生成
            const rpZip = new JSZip();
            const rp = rpZip.folder("RP");
            rp.file("manifest.json", JSON.stringify({
                "format_version": 1,
                "header": {
                    "description": description,
                    "name": name,
                    "uuid": UUIDA,
                    "version": [1, 0, 0],
                    "min_engine_version": [1, 19, 0]
                },
                "modules": [
                    {
                        "description": description,
                        "type": "resources",
                        "uuid": UUIDB,
                        "version": [1, 0, 0]
                    }
                ],
                 "dependencies": [
                {
                 "uuid":UUIDC,
                  "version":[1,0,0]
                }
             ]
            }, null, 2));
            const rpTextures = rp.folder("textures");
            const texturesItems = rpTextures.folder("items");
            texturesItems.file(`${itemEnglishName}.png`, await itemImageFile.arrayBuffer());
            rpTextures.file("item_texture.json", JSON.stringify({
                "resource_pack_name": englishName,
                "texture_name": "atlas.items",
                "texture_data": {
                    [itemEnglishName]: {
                        "textures": `textures/items/${itemEnglishName}`
                    }
                }
            }, null, 2));

            // BP ZIPファイルの生成
            const bpZip = new JSZip();
            const bp = bpZip.folder("BP");
            bp.file("manifest.json", JSON.stringify({
                "format_version": 2,
                "header": {
                    "description": description,
                    "name": name,
                    "uuid": UUIDC,
                    "version": [1, 0, 0],
                    "min_engine_version": [1, 19, 0]
                },
                "modules": [
                    {
                        "description": description,
                        "type": "data",
                        "uuid": UUIDD,
                        "version": [1, 0, 0]
                    }
                ],
                "dependencies": [
                    {
                        "uuid": UUIDA,
                        "version": [1, 0, 0]
                    }
                ]
            }, null, 2));
            const bpItems = bp.folder("items");
            bpItems.file(`${itemName}.json`, JSON.stringify({
                "format_version": "1.21.10",
                "minecraft:item": {
                    "description": {
                        "identifier": `${englishName}:${itemEnglishName}`,
                        "menu_category": {
                            "category": "construction"
                        }
                    },
                    "components": {
                        "minecraft:max_stack_size": 64,
                        "minecraft:icon": itemEnglishName,
                        "minecraft:display_name": {
                            "value": itemName
                        }
                    }
                }
            }, null, 2));

            // RP MCPACKファイルを生成
            const rpZipBlob = await rpZip.generateAsync({ type: "blob" });
            const rpMcpack = new Blob([rpZipBlob], { type: "application/zip" });

            // BP MCPACKファイルを生成
            const bpZipBlob = await bpZip.generateAsync({ type: "blob" });
            const bpMcpack = new Blob([bpZipBlob], { type: "application/zip" });

            // MCAddon ZIPファイルの生成
            const mcaddonZip = new JSZip();
            mcaddonZip.file(`${name}_RP.mcpack`, rpMcpack);
            mcaddonZip.file(`${name}_BP.mcpack`, bpMcpack);

            const mcaddonBlob = await mcaddonZip.generateAsync({ type: "blob" });

            // ダウンロードリンクを設定
            const downloadLink = document.getElementById('download-link');
            // BlobをオブジェクトURLとして作成
            const mcaddonUrl = URL.createObjectURL(mcaddonBlob);
            downloadLink.href = mcaddonUrl;
            downloadLink.download = `${name}.mcaddon`; // ここで拡張子を.mcaddonに設定
            downloadLink.style.display = 'block';

            // ダウンロード完了後、オブジェクトURLを解放
            downloadLink.addEventListener('click', function () {
                setTimeout(() => URL.revokeObjectURL(mcaddonUrl), 100);
            });
        });
    </script>
</body>
</html>
